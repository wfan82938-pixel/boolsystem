<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>ä¾›è€…ä¿¡æ¯å½•å…¥</title>
  <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body{background:#f3f5f9;height:100vh;overflow:hidden;font-family:system-ui,-apple-system,sans-serif}
    .topbar{height:64px;background:#fff;border-bottom:1px solid #edf2f7;padding:0 24px;display:flex;align-items:center;justify-content:space-between}
    .card-wrap{height:calc(100vh - 64px);padding:24px;display:flex;justify-content:center}
    .form-card{background:#fff;border:1px solid #edf2f7;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.03);padding:30px;width:100%;max-width:900px;overflow:auto}
    .section-title{font-weight:700;color:#334155;margin:20px 0 15px;border-left:4px solid #3b82f6;padding-left:10px;font-size:1.05rem}
    .form-label{font-size:0.9rem;font-weight:600;color:#64748b}
  </style>
</head>
<div class="fixed-bottom text-center p-2 small bg-danger bg-opacity-10 text-danger fw-bold" style="font-size: 0.75rem; letter-spacing: 0.5px; border-top: 1px solid #fecaca;">
  <i class="bi bi-exclamation-octagon-fill me-1"></i>
  å…è´£å£°æ˜ï¼šæœ¬ç³»ç»Ÿä»…ä¾›ç§‘ç ”å‚è€ƒï¼Œä¸¥ç¦ç”¨äºä¸´åºŠåŒ»ç–—å†³ç­–ã€‚
</div>

<body>
<div class="topbar">
  <div class="d-flex align-items-center">
    <a href="/" class="btn btn-light border me-2"><i class="bi bi-arrow-left"></i></a>
    <strong>ä¾›è€…ä¿¡æ¯ç®¡ç†</strong>
  </div>
</div>

<div class="card-wrap">
  <form th:object="${donor}" th:action="@{/save}" method="post" class="form-card">

    <!-- ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šä¹è§‚é”ç‰ˆæœ¬å·å¿…é¡»ä½œä¸ºéšè—å­—æ®µæäº¤ -->
    <input type="hidden" th:field="*{version}"/>

    <!-- å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼ŒID å·²å­˜åœ¨ï¼›å¦‚æœæ˜¯æ–°å¢ï¼ŒID ä¸ºç©º -->
    <!-- æ³¨æ„ï¼šä¸è¦è®© ID å­—æ®µ disabledï¼Œå¦åˆ™ POST è¯·æ±‚ä¸ä¼šæäº¤å®ƒï¼Œæ”¹ç”¨ readonly -->

    <div class="section-title mt-0">åŸºæœ¬ä¿¡æ¯</div>
    <div class="row g-3">
      <div class="col-md-3">
        <label class="form-label">ID (è‡ªåŠ¨ç”Ÿæˆ/åªè¯»)</label>
        <input th:field="*{donorId}" class="form-control bg-light font-monospace" readonly placeholder="ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ">
      </div>
      <div class="col-md-3">
        <label class="form-label">å§“å <span class="text-danger">*</span></label>
        <input th:field="*{name}" class="form-control" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">æ€§åˆ«</label>
        <select th:field="*{gender}" class="form-select">
          <option value="">-</option><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">å¹´é¾„</label>
        <input type="number" th:field="*{age}" class="form-control" min="0" max="120">
      </div>
      <div class="col-md-2">
        <label class="form-label">è¡€å‹ <span class="text-danger">*</span></label>
        <select th:field="*{bloodType}" class="form-select" required>
          <option value="æœªçŸ¥">æœªçŸ¥</option>
          <option value="A">A</option><option value="B">B</option><option value="O">O</option><option value="AB">AB</option>
        </select>
      </div>
    </div>

    <div class="section-title">HPA åŸºå› åˆ†å‹</div>
    <div class="row g-2">
      <!-- ä½¿ç”¨ Thymeleaf å¾ªç¯ç”Ÿæˆ HPA é€‰æ‹©æ¡† -->
      <div class="col-4 col-md-2" th:each="k : ${ {'hpa1','hpa2','hpa3','hpa4','hpa5','hpa6','hpa10','hpa15','hpa21'} }">
        <label class="form-label text-dark small" th:text="${#strings.toUpperCase(#strings.replace(k,'hpa','HPA-'))}"></label>
        <select class="form-select form-select-sm" th:field="*{__${k}__}">
          <option value="">-</option><option value="aa">aa</option><option value="bb">bb</option><option value="ab">ab</option>
        </select>
      </div>
    </div>

    <div class="section-title">HLA åŸºå› åˆ†å‹ (é«˜åˆ†è¾¨)</div>
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">HLA-A ä½ç‚¹</label>
        <div class="input-group">
          <span class="input-group-text bg-light text-secondary">A1</span>
          <input th:field="*{hlaA1}" class="form-control" placeholder="ä¾‹: 30:01:01">
          <span class="input-group-text bg-light text-secondary">A2</span>
          <input th:field="*{hlaA2}" class="form-control" placeholder="ä¾‹: 02:01:01">
        </div>
      </div>
      <div class="col-md-6">
        <label class="form-label">HLA-B ä½ç‚¹</label>
        <div class="input-group">
          <span class="input-group-text bg-light text-secondary">B1</span>
          <input th:field="*{hlaB1}" class="form-control" placeholder="ä¾‹: 13:02:01">
          <span class="input-group-text bg-light text-secondary">B2</span>
          <input th:field="*{hlaB2}" class="form-control" placeholder="ä¾‹: 15:18:01">
        </div>
      </div>
    </div>

    <div class="text-end mt-4 pt-3 border-top">
      <a href="/" class="btn btn-light me-2 px-4">å–æ¶ˆ</a>
      <button type="submit" class="btn btn-primary px-5 fw-bold">ä¿å­˜ä¿¡æ¯</button>
    </div>
  </form>
</div>

<!-- ğŸ”¥ æ–°å¢è„šæœ¬ï¼šåœ¨æäº¤å‰è‡ªåŠ¨è¡¥å…¨ HLA å‰ç¼€ -->
<script>
  document.querySelector('form').addEventListener('submit', function(e) {
    // è¾…åŠ©å‡½æ•°ï¼šæ ‡å‡†åŒ– HLA è¾“å…¥
    function normalizeHla(fieldId, type) {
      var input = document.getElementById(fieldId);
      if (!input) return;

      var val = input.value.trim();
      if (!val) return; // ç©ºå€¼ä¸å¤„ç†ï¼Œé˜²æ­¢æäº¤å•çº¯çš„ "HLA-A*"

      var upper = val.toUpperCase();
      var prefixFull = 'HLA-' + type + '*'; // e.g. HLA-A*
      var prefixShort = type + '*';          // e.g. A*

      if (upper.startsWith(prefixFull)) {
        // 1. å·²ç»åŒ…å«å®Œæ•´å‰ç¼€ (å¦‚ HLA-A*02:01)ï¼Œä¸åšå¤„ç†ï¼Œé˜²æ­¢é‡å¤
        return;
      } else if (upper.startsWith(prefixShort)) {
        // 2. åŒ…å«ç®€å†™å‰ç¼€ (å¦‚ A*02:01)ï¼Œè¡¥å…¨ HLA-
        input.value = "HLA-" + val;
      } else {
        // 3. çº¯æ•°å­—æˆ–å…¶ä»– (å¦‚ 02:01)ï¼Œè¡¥å…¨å®Œæ•´å‰ç¼€ HLA-A*
        input.value = prefixFull + val;
      }
    }

    // æ‰§è¡Œè¡¥å…¨é€»è¾‘
    normalizeHla('hlaA1', 'A');
    normalizeHla('hlaA2', 'A');
    normalizeHla('hlaB1', 'B');
    normalizeHla('hlaB2', 'B');
  });
</script>

</body>
</html>