<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>æ™ºèƒ½é…å‹ä¸­å¿ƒ</title>
    <meta th:if="${_csrf}" name="_csrf" th:content="${_csrf.token}"/>
    <meta th:if="${_csrf}" name="_csrf_header" th:content="${_csrf.headerName}"/>

    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        body { background-color: #f5f7fa; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        body::after {
            content: "ç§‘ç ”è¾…åŠ© Â· ä»…ä¾›å‚è€ƒ";
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 6rem;
            color: rgba(0,0,0,0.04);
            pointer-events: none;
            z-index: 9999;
            white-space: nowrap;
            font-weight: 800;
        }

        .navbar { height: 60px; background: #fff; border-bottom: 1px solid #eef1f6; flex-shrink: 0; padding: 0 24px; display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .main-container { flex: 1; display: flex; overflow: hidden; position: relative; z-index: 10; }

        .sidebar { width: 340px; background: #fff; border-right: 1px solid #eef1f6; display: flex; flex-direction: column; z-index: 90; box-shadow: 4px 0 10px rgba(0,0,0,0.02); }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #f0f2f5; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 20px; }
        .sidebar-footer { padding: 15px 20px; border-top: 1px solid #f0f2f5; background: #fafafa; }

        .content-area { flex: 1; padding: 30px; overflow-y: auto; background: #f5f7fa; position: relative; display: flex; flex-direction: column; }

        .form-section-title { font-size: 0.85rem; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin: 20px 0 10px; }
        .form-section-title:first-child { margin-top: 0; }

        .gene-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed #f1f5f9; }
        .gene-name { font-weight: 600; font-size: 0.9rem; color: #334155; width: 60px; }

        /* ğŸ”¥ æ–°ç‰ˆå¡ç‰‡æ ·å¼ - ç»¿è‰²/æ¸…æ–°é£æ ¼ */
        .result-card { background: #fff; border-radius: 12px; border: 1px solid #e2e8f0; padding: 20px; margin-bottom: 15px; transition: all 0.2s; position: relative; overflow: hidden; }
        .result-card:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); border-color: #cbd5e1; }
        .result-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #cbd5e1; }

        /* é»˜è®¤/Mid ä¹Ÿæ˜¯åç»¿è‰²/é’è‰² */
        .result-card.score-high::before { background: #10b981; } /* çº¯ç»¿ */
        .result-card.score-mid::before { background: #0ea5e9; } /* é’è“è‰² */
        .result-card.score-low::before { background: #f59e0b; }
        /* å†²çª/æ’é™¤æ ·å¼ */
        .result-card.score-excluded { border: 1px solid #fca5a5; background: #fff5f5; opacity: 0.8; }
        .result-card.score-excluded::before { background: #ef4444; }
        .result-card.score-excluded .text-dark { color: #7f1d1d !important; }

        .score-badge { position: absolute; right: 20px; top: 20px; text-align: right; }
        .score-num { font-size: 2rem; font-weight: 800; line-height: 1; letter-spacing: -1px; }
        .score-label { font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; font-weight: 600; }

        .grade-badge { position: absolute; right: 100px; top: 20px; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1.2rem; color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .grade-A { background: #10b981; }
        .grade-B { background: #0ea5e9; }
        .grade-C { background: #f59e0b; }
        .grade-D { background: #94a3b8; }
        .grade-Ex { background: #ef4444; } /* Excluded */

        .hla-tag { background: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem; font-family: 'Consolas', monospace; font-weight: 600; }
        .hla-tag.matched { background-color: #d1fae5 !important; color: #059669 !important; border-color: #10b981 !important; }

        /* ğŸ”¥ æŠ—ä½“æ ‡ç­¾è¾“å…¥æ¡†æ ·å¼ (Tag Input) */
        .antibody-container {
            min-height: 80px;
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px;
            cursor: text;
            transition: all 0.2s;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-content: flex-start;
        }
        .antibody-container:focus-within {
            border-color: #ef4444; /* çº¢è‰²ç„¦ç‚¹æ¡†ï¼Œæç¤ºè¿™æ˜¯æ’é™¤é¡¹ */
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }
        .antibody-tag {
            background-color: #fef2f2;
            color: #b91c1c;
            border: 1px solid #fecaca;
            border-radius: 100px; /* èƒ¶å›ŠçŠ¶ */
            padding: 2px 10px;
            font-size: 0.85rem;
            font-family: 'Consolas', monospace;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            animation: fadeIn 0.2s ease-out;
        }
        .antibody-tag i {
            cursor: pointer;
            font-size: 0.9rem;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .antibody-tag i:hover { opacity: 1; }
        .antibody-input-field {
            border: none;
            outline: none;
            font-size: 0.9rem;
            flex: 1;
            min-width: 60px;
            background: transparent;
            color: #334155;
            padding: 4px 0;
            font-family: 'Consolas', monospace;
        }
        .antibody-input-field::placeholder { color: #cbd5e1; font-family: system-ui, -apple-system, sans-serif; }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        #loadingOverlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(245,247,250,0.8); backdrop-filter: blur(2px); z-index: 50; display: none; justify-content: center; align-items: center; flex-direction: column; }

        .footer-disclaimer { margin-top: auto; padding-top: 30px; text-align: center; font-size: 0.8rem; color: #94a3b8; }
    </style>
</head>
<body>

<div class="navbar">
    <div class="d-flex align-items-center gap-2">
        <i class="bi bi-diagram-3-fill text-success fs-4"></i>
        <span class="fw-bold fs-5 text-dark">æ™ºèƒ½é…å‹ä¸­å¿ƒ</span>
    </div>
    <a href="/" class="btn btn-outline-secondary btn-sm px-3 fw-bold"><i class="bi bi-arrow-return-left me-1"></i> è¿”å›åˆ—è¡¨</a>
</div>

<div class="main-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <button class="btn btn-success w-100 py-2 fw-bold shadow-sm" id="btnMatch" onclick="doMatch()">
                <i class="bi bi-search me-1"></i> ç«‹å³é…å‹
            </button>
            <button class="btn btn-light w-100 mt-2 text-muted btn-sm" onclick="resetForm()">
                <i class="bi bi-arrow-counterclockwise me-1"></i> é‡ç½®æ‰€æœ‰æ¡ä»¶
            </button>
        </div>

        <div class="sidebar-content">
            <div class="form-section-title">åŸºç¡€ä¿¡æ¯</div>
            <div class="mb-3">
                <label class="small text-muted mb-1">æ‚£è€…è¡€å‹</label>
                <select class="form-select" id="bloodType">
                    <option value="">ä¸é™</option>
                    <option value="A">A å‹</option>
                    <option value="B">B å‹</option>
                    <option value="O">O å‹</option>
                    <option value="AB">AB å‹</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="small text-muted mb-1 fw-bold text-danger d-flex justify-content-between align-items-center">
                    <span>æ’é™¤æŠ—ä½“ (DSA)</span>
                    <i class="bi bi-shield-x"></i>
                </label>
                <!-- ğŸ”¥ æ–°ç‰ˆ Tag Input ç»“æ„ -->
                <div class="antibody-container" id="antibodyWrapper" onclick="document.getElementById('antibodyInput').focus()">
                    <!-- æ ‡ç­¾ä¼šåŠ¨æ€æ’å…¥åˆ°è¿™é‡Œ -->
                    <input type="text" class="antibody-input-field" id="antibodyInput" placeholder="è¾“å…¥åå›è½¦..." autocomplete="off">
                </div>
                <!-- éšè—åŸŸï¼Œç”¨äºå­˜å‚¨å®é™…æäº¤çš„é€—å·åˆ†éš”å­—ç¬¦ä¸² -->
                <input type="hidden" id="antibodiesHidden">
                <div class="text-xs text-muted mt-1" style="font-size: 0.7rem;">è¾“å…¥å¦‚ "A*02" æˆ– "B*13" åæŒ‰å›è½¦æˆ–é€—å·ã€‚</div>
            </div>

            <div class="form-section-title">HLA é«˜åˆ†è¾¨åˆ†å‹</div>
            <div class="mb-3">
                <label class="small text-muted mb-1 d-flex justify-content-between">
                    <span>HLA-A ä½ç‚¹</span>
                    <span class="text-xs text-muted" style="font-size: 0.7rem;">è¾“å…¥ä¸¤æ¡é“¾</span>
                </label>
                <div class="input-group input-group-sm mb-1">
                    <span class="input-group-text bg-light text-secondary border-end-0" style="width: 35px;">1</span>
                    <input type="text" class="form-control font-monospace border-start-0" id="hlaA1" placeholder="ä¾‹ 30:01" oninput="this.value = this.value.toUpperCase()">
                </div>
                <div class="input-group input-group-sm">
                    <span class="input-group-text bg-light text-secondary border-end-0" style="width: 35px;">2</span>
                    <input type="text" class="form-control font-monospace border-start-0" id="hlaA2" placeholder="ä¾‹ 02:01" oninput="this.value = this.value.toUpperCase()">
                </div>
            </div>

            <div class="mb-3">
                <label class="small text-muted mb-1 d-flex justify-content-between">
                    <span>HLA-B ä½ç‚¹</span>
                    <span class="text-xs text-muted" style="font-size: 0.7rem;">è¾“å…¥ä¸¤æ¡é“¾</span>
                </label>
                <div class="input-group input-group-sm mb-1">
                    <span class="input-group-text bg-light text-secondary border-end-0" style="width: 35px;">1</span>
                    <input type="text" class="form-control font-monospace border-start-0" id="hlaB1" placeholder="ä¾‹ 13:02" oninput="this.value = this.value.toUpperCase()">
                </div>
                <div class="input-group input-group-sm">
                    <span class="input-group-text bg-light text-secondary border-end-0" style="width: 35px;">2</span>
                    <input type="text" class="form-control font-monospace border-start-0" id="hlaB2" placeholder="ä¾‹ 15:18" oninput="this.value = this.value.toUpperCase()">
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="form-section-title mb-0">HPA åŸºå› å‹</div>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-xs btn-link text-decoration-none text-muted p-0 me-2" onclick="setAllHpa('aa')">å…¨aa</button>
                    <button class="btn btn-xs btn-link text-decoration-none text-muted p-0" onclick="setAllHpa('bb')">å…¨bb</button>
                </div>
            </div>

            <div id="hpaListContainer"></div>
        </div>

        <div class="sidebar-footer">
            <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" id="limitResult">
                <label class="form-check-label small text-muted" for="limitResult">ä»…æ˜¾ç¤ºå‰ 50 æ¡</label>
            </div>
        </div>
    </div>

    <div class="content-area">
        <div id="loadingOverlay">
            <div class="spinner-border text-success mb-2" role="status"></div>
            <div class="text-muted small fw-bold">æ­£åœ¨å…¨åº“æ£€ç´¢...</div>
        </div>

        <div class="d-flex justify-content-between align-items-end mb-4">
            <div>
                <h4 class="fw-bold text-dark mb-1">é…å‹ç»“æœ</h4>
                <div class="text-muted small" id="resultStatus">è¯·åœ¨å·¦ä¾§è¾“å…¥æ¡ä»¶åç‚¹å‡»é…å‹</div>
            </div>
        </div>

        <div id="resultList">
            <div class="text-center py-5 mt-5">
                <i class="bi bi-clipboard-data display-1 text-light"></i>
                <p class="text-muted mt-3">ç­‰å¾…è¾“å…¥é…å‹æ¡ä»¶...</p>
            </div>
        </div>

        <div class="footer-disclaimer">
            <hr class="mb-3">
            <p><span class="text-danger fw-bold">å…è´£å£°æ˜ï¼š</span>æœ¬ç³»ç»Ÿä»…ä½œä¸ºç§‘ç ”æ•°æ®ç®¡ç†ä¸è¾…åŠ©æ£€ç´¢å·¥å…·ï¼Œé…å‹ç»“æœä»…ä¾›å‚è€ƒï¼Œ<br>ä¸¥ç¦ç›´æ¥ä½œä¸ºä¸´åºŠè¾“è¡€/ç§»æ¤çš„å”¯ä¸€ä¾æ®ã€‚æœ€ç»ˆåŒ»ç–—å†³ç­–è¯·éµå¾ªä¸´åºŠæ£€éªŒæ ‡å‡†ã€‚</p>
        </div>
    </div>
</div>

<script th:src="@{/js/jquery.min.js}"></script>
<script th:src="@{/js/bootstrap.bundle.min.js}"></script>

<script>
    var token = $("meta[name='_csrf']").attr("content");
    var header = $("meta[name='_csrf_header']").attr("content");
    if (token && header) {
        $(document).ajaxSend(function(e, xhr, options) {
            xhr.setRequestHeader(header, token);
        });
    }

    const hpas = ['HPA-1', 'HPA-2', 'HPA-3', 'HPA-4', 'HPA-5', 'HPA-6', 'HPA-10', 'HPA-15', 'HPA-21'];
    const hpaContainer = $('#hpaListContainer');

    hpas.forEach(h => {
        const html = `
            <div class="gene-row">
                <div class="gene-name">${h}</div>
                <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="${h}" id="${h}_aa" value="aa" autocomplete="off">
                    <label class="btn btn-outline-secondary py-0 px-2" style="font-size: 0.75rem; line-height: 1.8;" for="${h}_aa">aa</label>

                    <input type="radio" class="btn-check" name="${h}" id="${h}_ab" value="ab" autocomplete="off">
                    <label class="btn btn-outline-secondary py-0 px-2" style="font-size: 0.75rem; line-height: 1.8;" for="${h}_ab">ab</label>

                    <input type="radio" class="btn-check" name="${h}" id="${h}_bb" value="bb" autocomplete="off">
                    <label class="btn btn-outline-secondary py-0 px-2" style="font-size: 0.75rem; line-height: 1.8;" for="${h}_bb">bb</label>
                </div>
            </div>
        `;
        hpaContainer.append(html);
    });

    // --- ğŸ”¥ æŠ—ä½“æ ‡ç­¾ Tag Input é€»è¾‘ ---
    const antibodyInput = document.getElementById('antibodyInput');
    const antibodyWrapper = document.getElementById('antibodyWrapper');
    const antibodiesHidden = document.getElementById('antibodiesHidden');
    let tags = [];

    function updateTags() {
        // æ¸…é™¤ç°æœ‰çš„ tag å…ƒç´  (ä¿ç•™ input)
        const existingTags = antibodyWrapper.querySelectorAll('.antibody-tag');
        existingTags.forEach(t => t.remove());

        // é‡æ–°æ¸²æŸ“
        tags.forEach((tag, index) => {
            const tagEl = document.createElement('div');
            tagEl.className = 'antibody-tag';
            tagEl.innerHTML = `${tag} <i class="bi bi-x" onclick="removeTag(${index})"></i>`;
            antibodyWrapper.insertBefore(tagEl, antibodyInput);
        });
        // æ›´æ–°éšè—åŸŸçš„å€¼
        antibodiesHidden.value = tags.join(',');
    }

    function addTag(text) {
        const clean = text.trim().toUpperCase().replace(/[^A-Z0-9:*]/g, '');
        if (clean && !tags.includes(clean)) {
            tags.push(clean);
            updateTags();
        }
        antibodyInput.value = '';
    }

    window.removeTag = function(index) {
        tags.splice(index, 1);
        updateTags();
    };

    antibodyInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ',' || e.key === ' ') {
            e.preventDefault();
            addTag(this.value);
        } else if (e.key === 'Backspace' && this.value === '' && tags.length > 0) {
            removeTag(tags.length - 1);
        }
    });

    antibodyInput.addEventListener('blur', function() {
        if (this.value) addTag(this.value);
    });

    // --- End Tag Input Logic ---

    function setAllHpa(val) {
        hpas.forEach(h => $(`input[name="${h}"][value="${val}"]`).prop('checked', true));
    }

    function resetForm() {
        $('input[type="radio"]').prop('checked', false);
        $('#bloodType').val('');
        // é‡ç½®æŠ—ä½“æ ‡ç­¾
        tags = [];
        updateTags();
        $('#antibodyInput').val('');

        $('#hlaA1,#hlaA2,#hlaB1,#hlaB2').val('');
        $('#limitResult').prop('checked', false);
        $('#resultList').html('<div class="text-center py-5 mt-5"><i class="bi bi-arrow-counterclockwise display-1 text-light"></i><p class="text-muted mt-3">æ¡ä»¶å·²é‡ç½®</p></div>');
        $('#resultStatus').text('å‡†å¤‡å°±ç»ª');
    }

    function doMatch() {
        const cleanHla = (val) => val ? val.trim().replace(/ï¼š/g, ':').replace(/\s+/g, '') : '';

        // ç¡®ä¿è¾“å…¥æ¡†é‡Œæ®‹ç•™çš„æ–‡å­—ä¹Ÿè¢«æ·»åŠ ä¸º tag
        if(antibodyInput.value.trim()) {
            addTag(antibodyInput.value);
        }

        let params = {
            bloodType: $('#bloodType').val(),
            limitResult: $('#limitResult').is(':checked'),
            antibodies: $('#antibodiesHidden').val(), // ğŸ”¥ ä½¿ç”¨éšè—åŸŸçš„å€¼
            hlaA1: cleanHla($('#hlaA1').val()),
            hlaA2: cleanHla($('#hlaA2').val()),
            hlaB1: cleanHla($('#hlaB1').val()),
            hlaB2: cleanHla($('#hlaB2').val())
        };

        let hasHpa = false;
        hpas.forEach(h => {
            let val = $(`input[name="${h}"]:checked`).val();
            if (val) {
                params['hpa' + h.split('-')[1]] = val;
                hasHpa = true;
            }
        });

        if (!hasHpa && !params.bloodType && !params.hlaA1 && !params.hlaA2 && !params.hlaB1 && !params.hlaB2 && !params.antibodies) {
            alert("è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªé…å‹æ¡ä»¶ï¼");
            return;
        }

        $('#loadingOverlay').css('display', 'flex');
        $('#btnMatch').prop('disabled', true);

        $.post('/api/match', params, function(data) {
            renderResults(data);
        }).fail(function(xhr) {
            alert("é…å‹è¯·æ±‚å¤±è´¥ï¼š" + (xhr.status === 403 ? "æƒé™ä¸è¶³ï¼Œè¯·åˆ·æ–°é¡µé¢" : "æœåŠ¡å™¨é”™è¯¯"));
        }).always(function() {
            $('#loadingOverlay').hide();
            $('#btnMatch').prop('disabled', false);
        });
    }

    function getDonorVal(donor, locus) {
        if (!locus || !donor) return "?";
        if (locus.startsWith('HLA')) return "";
        let propName = locus.toLowerCase().replace('-', '');
        return donor[propName] || "?";
    }

    function renderResults(data) {
        const container = $('#resultList');
        container.empty();

        const validList = data.filter(d => d.score >= 0);
        const excludedList = data.filter(d => d.score < 0);


        const isLimited = $('#limitResult').is(':checked');
        let excludedDisplay = excludedList.length;
        let excludedSuffix = "";

        // å¦‚æœå¼€å¯äº†é™åˆ¶ï¼Œå¹¶ä¸”ç»“æœæ­£å¥½æ˜¯ 50 æ¡ï¼Œä¸”æ²¡æœ‰æ’é™¤è€…ï¼ˆæˆ–è€…å¾ˆå°‘ï¼‰ï¼Œè¯´æ˜æ’é™¤è€…å¯èƒ½åœ¨ 50 æ¡ä¹‹å
        if (isLimited && data.length === 50) {
            excludedSuffix = `<i class="bi bi-question-circle-fill ms-1" title="ç”±äºå¼€å¯äº†æ•°é‡é™åˆ¶ï¼Œéƒ¨åˆ†æˆ–å…¨éƒ¨è¢«æ’é™¤çš„ä¾›è€…æœªåŠ è½½"></i>`;
            if (excludedList.length === 0) {
                // å¼ºåˆ¶æç¤ºï¼Œé¿å…ç”¨æˆ·ä»¥ä¸ºåŠŸèƒ½å¤±æ•ˆ
                excludedSuffix = `<span class="small opacity-50 ms-1">(ç”±äºå¼€å¯äº†æ•°é‡é™åˆ¶ï¼Œéƒ¨åˆ†æˆ–å…¨éƒ¨è¢«æ’é™¤çš„ä¾›è€…æœªåŠ è½½...)</span>`;
            }
        }

        $('#resultStatus').html(`
            æ‰¾åˆ° <strong class="text-dark">${data.length}</strong> æ¡è®°å½•
            <span class="text-secondary mx-2">|</span>
            <span class="text-success fw-bold"><i class="bi bi-check-circle me-1"></i>å¯ç”¨: ${validList.length}</span>
            <span class="text-secondary mx-2">|</span>
            <span class="text-danger fw-bold"><i class="bi bi-x-circle me-1"></i>æ’é™¤: ${excludedDisplay} ${excludedSuffix}</span>
        `);

        if (data.length === 0) {
            container.html(`
                <div class="alert alert-warning border-0 shadow-sm text-center py-4">
                    <i class="bi bi-exclamation-triangle fs-3 d-block mb-2"></i>
                    æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ä¾›è€…<br>
                    <small class="text-muted">è¯·å°è¯•æ”¾å®½æ¡ä»¶æˆ–æ£€æŸ¥è¾“å…¥ã€‚</small>
                </div>
            `);
            return;
        }

        data.forEach(item => {
            const d = item.donor;
            const isExcluded = item.score < 0;

            let cardClass = isExcluded ? 'score-excluded' : 'score-mid';
            let scoreColor = '#0ea5e9'; // é»˜è®¤é’è‰²
            let gradeClass = 'grade-D';

            if (!isExcluded) {
                if (item.score >= 300) { cardClass = 'score-high'; scoreColor = '#10b981'; }
                else if (item.score < 100) { cardClass = 'score-low'; scoreColor = '#f59e0b'; }

                if (item.grade === 'A') gradeClass = 'grade-A';
                else if (item.grade === 'B') gradeClass = 'grade-B';
                else if (item.grade === 'C') gradeClass = 'grade-C'; // åŸé»„è‰²ï¼Œç°å˜ä¸ºæ©™è‰²
            } else {
                scoreColor = '#ef4444';
                gradeClass = 'grade-Ex';
            }

            let tagsHtml = '';

            item.matchedLoci.forEach(l => {
                if(l.startsWith('HLA')) return;
                let val = getDonorVal(d, l);
                tagsHtml += `<span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 me-1">${l}:${val}</span>`;
            });

            if (item.compatibleLoci) {
                item.compatibleLoci.forEach(l => {
                    let val = getDonorVal(d, l);
                    tagsHtml += `<span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 me-1">${l}:${val} (ç›¸å®¹)</span>`;
                });
            }

            item.mismatchedLoci.forEach(l => {
                if(l.startsWith('HLA')) return;
                let val = getDonorVal(d, l);
                tagsHtml += `<span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25 me-1">${l}:${val}</span>`;
            });

            const hA1 = item.highlightedAlleles && item.highlightedAlleles.includes("HLA-A1");
            const hA2 = item.highlightedAlleles && item.highlightedAlleles.includes("HLA-A2");
            const hB1 = item.highlightedAlleles && item.highlightedAlleles.includes("HLA-B1");
            const hB2 = item.highlightedAlleles && item.highlightedAlleles.includes("HLA-B2");

            let hlaInfo = '';
            if(d.hlaA1 || d.hlaB1) {
                hlaInfo = `
                    <div class="mt-3 pt-2 border-top d-flex gap-4 text-secondary small">
                        <div>
                            <span class="fw-bold text-dark me-1">HLA-A:</span>
                            <span class="hla-tag ${hA1 ? 'matched' : ''}">${d.hlaA1||'-'}</span>
                            <span class="text-muted mx-1">|</span>
                            <span class="hla-tag ${hA2 ? 'matched' : ''}">${d.hlaA2||'-'}</span>
                        </div>
                        <div>
                            <span class="fw-bold text-dark me-1">HLA-B:</span>
                            <span class="hla-tag ${hB1 ? 'matched' : ''}">${d.hlaB1||'-'}</span>
                            <span class="text-muted mx-1">|</span>
                            <span class="hla-tag ${hB2 ? 'matched' : ''}">${d.hlaB2||'-'}</span>
                        </div>
                    </div>
                `;
            }

            let conflictHtml = '';
            if (isExcluded && item.conflictReasons && item.conflictReasons.length > 0) {
                conflictHtml = `<div class="mt-2 text-danger small fw-bold"><i class="bi bi-x-circle-fill me-1"></i>æ’é™¤åŸå› ï¼š${item.conflictReasons.join(', ')}</div>`;
            }

            let progressHtml = '';
            if(!isExcluded && item.rate > 0) {
                progressHtml = `
                    <div class="mt-2">
                        <div class="d-flex justify-content-between small text-muted mb-1">
                            <span>HPA åŒ¹é…åº¦</span>
                            <span class="fw-bold" style="color:${scoreColor}">${item.rate.toFixed(0)}%</span>
                        </div>
                        <div class="progress" style="height: 4px;">
                            <div class="progress-bar" style="width: ${item.rate}%; background-color: ${scoreColor}"></div>
                        </div>
                    </div>
                `;
            }

            let displayGrade = isExcluded ? 'X' : item.grade;

            let scoreDisplayHtml = '';
            if (isExcluded) {
                scoreDisplayHtml = `
                    <div class="text-danger fw-bold" style="font-size: 1.5rem;">ç¦å¿Œ</div>
                    <div class="score-label">çŠ¶æ€</div>
                `;
            } else {
                scoreDisplayHtml = `
                    <div class="score-num" style="color: ${scoreColor}">${item.score.toFixed(0)}</div>
                    <div class="score-label">æ€»åˆ†</div>
                `;
            }

            const html = `
                <div class="result-card ${cardClass}">
                    <div class="grade-badge ${gradeClass}">${displayGrade}</div>
                    <div class="score-badge">
                        ${scoreDisplayHtml}
                    </div>
                    <div style="padding-right: 150px;">
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <h5 class="fw-bold text-dark mb-0">${d.name}</h5>
                            <span class="badge bg-light text-dark border">${d.bloodType}å‹</span>
                            <span class="small text-muted font-monospace">ID: ${d.donorId}</span>
                        </div>
                        <div class="mb-2">${tagsHtml}</div>
                        ${conflictHtml}
                        ${progressHtml}
                        ${hlaInfo}
                    </div>
                </div>
            `;
            container.append(html);
        });
    }
</script>
</body>
</html>